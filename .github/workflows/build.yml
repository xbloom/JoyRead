name: Build IPA

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'  # ç›‘å¬ v å¼€å¤´çš„ tagï¼Œå¦‚ v1.0.0
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build:
    runs-on: macos-latest
    permissions:
      contents: write  # å…è®¸åˆ›å»º release
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: latest-stable
    
    - name: Install XcodeGen
      run: brew install xcodegen
    
    - name: Generate Xcode Project
      run: xcodegen generate
    
    - name: Build IPA (Unsigned for TrollStore)
      run: |
        xcodebuild archive \
          -project NovelReaderApp.xcodeproj \
          -scheme NovelReaderApp \
          -configuration Release \
          -archivePath build/NovelReaderApp.xcarchive \
          -sdk iphoneos \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          DEVELOPMENT_TEAM=""
        
        mkdir -p build/Payload
        cp -r build/NovelReaderApp.xcarchive/Products/Applications/NovelReaderApp.app build/Payload/
        cd build && zip -r NovelReaderApp.ipa Payload
        
        echo "âœ… æœªç­¾å IPA æ„å»ºå®Œæˆï¼ˆé€‚ç”¨äº TrollStoreï¼‰"
    
    - name: Upload IPA
      uses: actions/upload-artifact@v4
      with:
        name: JoyRead-IPA
        path: build/NovelReaderApp.ipa
        retention-days: 30
    
    - name: Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: build/NovelReaderApp.ipa
        name: JoyRead ${{ github.ref_name }}
        body: |
          ## JoyRead - æ‚¦è¯»
          
          ### å®‰è£…æ–¹æ³•
          1. ä¸‹è½½ `NovelReaderApp.ipa`
          2. ä½¿ç”¨ TrollStore å®‰è£…
          
          ### åŠŸèƒ½ç‰¹æ€§
          - ğŸ“š æ”¯æŒé”™å±‚ç½‘ã€é›¶ç‚¹çœ‹ä¹¦
          - ğŸ¨ ä¸‰ç§é˜…è¯»ä¸»é¢˜
          - ğŸ“– è‡ªåŠ¨åˆå¹¶åˆ†é¡µç« èŠ‚
          - ğŸ’¾ æ™ºèƒ½ç¼“å­˜
          
          ### æ”¯æŒçš„ç½‘ç«™
          - cuoceng.com (é”™å±‚å°è¯´ç½‘)
          - 23txtv.com (é›¶ç‚¹çœ‹ä¹¦)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
